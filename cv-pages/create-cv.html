<!DOCTYPE html>
<html lang="kk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stroyka.kz - Резюме жасау</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: #f5f7fa;
            color: #1d1d1f;
            padding-bottom: 100px;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 1rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .header-title {
            font-size: 1.3rem;
            font-weight: 600;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        .section {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #333;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .form-row-full {
            grid-column: 1 / -1;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
            background: white;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        input.error, select.error {
            border-color: #ff4444;
        }

        .error-message {
            color: #ff4444;
            font-size: 0.85rem;
            margin-top: 0.25rem;
            display: none;
        }

        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: #45a049;
        }

        .btn-outline {
            background: transparent;
            color: #4CAF50;
            border: 2px solid #4CAF50;
        }

        .btn-outline:hover {
            background: #4CAF50;
            color: white;
        }

        .btn-selector {
            background: #f8f9fa;
            color: #333;
            border: 2px solid #e1e5e9;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1rem;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-selector:hover {
            border-color: #4CAF50;
        }

        .btn-selector.selected {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .checkbox-group label {
            margin: 0;
            font-weight: 400;
        }

        .submit-btn {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 2rem;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.4);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .success-icon {
            width: 60px;
            height: 60px;
            background: #4CAF50;
            border-radius: 50%;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .multi-select {
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 0.5rem;
            min-height: 100px;
            max-height: 200px;
            overflow-y: auto;
        }

        .multi-select-item {
            padding: 0.5rem;
            margin: 0.25rem 0;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .multi-select-item:hover {
            background: #e9ecef;
        }

        .multi-select-item.selected {
            background: #4CAF50;
            color: white;
        }

        .work-experience-item, .education-item {
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .remove-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .add-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .file-upload-container {
            position: relative;
        }

        .photo-preview {
            position: relative;
            display: inline-block;
            margin-bottom: 1rem;
        }

        .remove-photo-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-upload-area {
            border: 2px dashed #e1e5e9;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
            background: #fafafa;
        }

        .file-upload-area:hover {
            border-color: #4CAF50;
            background: #f0f8f0;
        }

        .upload-placeholder p {
            margin: 0.5rem 0;
            font-weight: 500;
            color: #666;
        }

        .upload-placeholder span {
            font-size: 0.85rem;
            color: #999;
        }

        .course-file-upload {
            border: 1px solid #e1e5e9;
            border-radius: 6px;
            padding: 0.5rem;
            background: #f8f9fa;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: border-color 0.3s;
        }

        .course-file-upload:hover {
            border-color: #4CAF50;
        }

        .course-file-upload.has-file {
            background: #e8f5e8;
            border-color: #4CAF50;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            color: #666;
        }

        .file-info.uploaded {
            color: #2d5a32;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 1rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <button class="back-btn" onclick="goBack()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                </svg>
                <span data-kk="Артқа" data-ru="Назад">Артқа</span>
            </button>
            <h1 class="header-title" data-kk="Резюме жасау" data-ru="Создание резюме">Резюме жасау</h1>
            <button class="logout-btn" onclick="logout()" data-kk="Шығу" data-ru="Выйти">Шығу</button>
        </div>
    </div>

    <div class="container">
        <!-- Personal Information Section -->
        <div class="section">
            <h2 class="section-title" data-kk="Жеке ақпарат" data-ru="Личная информация">Жеке ақпарат</h2>
            
            <!-- User Photo Upload -->
            <div class="form-group">
                <label data-kk="Фото" data-ru="Фото">Фото</label>
                <div class="file-upload-container">
                    <div class="photo-preview" id="photoPreview" style="display: none;">
                        <img id="photoImage" style="width: 150px; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #e1e5e9;">
                        <button type="button" class="remove-photo-btn" onclick="removePhoto()">×</button>
                    </div>
                    <div class="file-upload-area" id="photoUploadArea">
                        <input type="file" id="userPhoto" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                        <div class="upload-placeholder" onclick="document.getElementById('userPhoto').click()">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="#ccc">
                                <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.1 3.89 23 5 23H19C20.1 23 21 22.1 21 21V9H21ZM19 21H5V19L8 16L11 19L14 16L19 21Z"/>
                            </svg>
                            <p data-kk="Фото жүктеу үшін басыңыз" data-ru="Нажмите для загрузки фото">Фото жүктеу үшін басыңыз</p>
                            <span data-kk="JPG, PNG форматы" data-ru="Формат JPG, PNG">JPG, PNG форматы</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label data-kk="Аты" data-ru="Имя">Аты</label>
                    <input type="text" id="firstName" placeholder="Аскар">
                    <div class="error-message" id="firstNameError"></div>
                </div>
                <div class="form-group">
                    <label data-kk="Тегі" data-ru="Фамилия">Тегі</label>
                    <input type="text" id="surName" placeholder="Назарбаев">
                    <div class="error-message" id="surNameError"></div>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label data-kk="Әкесінің аты" data-ru="Отчество">Әкесінің аты</label>
                    <input type="text" id="middleName" placeholder="Нұрсұлтанұлы">
                </div>
                <div class="form-group">
                    <label data-kk="Телефон" data-ru="Телефон">Телефон</label>
                    <input type="tel" id="phoneNumber" readonly>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label data-kk="Email" data-ru="Email">Email</label>
                    <input type="email" id="email" placeholder="askar@example.com">
                    <div class="error-message" id="emailError"></div>
                </div>
                <div class="form-group">
                    <label data-kk="Қала" data-ru="Город">Қала</label>
                    <button type="button" class="btn-selector" id="cityBtn" onclick="selectCity()">
                        <span data-kk="Қаланы таңдаңыз" data-ru="Выберите город">Қаланы таңдаңыз</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 10l5 5 5-5z"/>
                        </svg>
                    </button>
                    <div class="error-message" id="cityError"></div>
                </div>
            </div>
        </div>

        <!-- Work Preferences Section -->
        <div class="section">
            <h2 class="section-title" data-kk="Жұмыс туралы ақпарат" data-ru="Информация о работе">Жұмыс туралы ақпарат</h2>
            <div class="form-group">
                <label data-kk="Мамандықтар" data-ru="Профессии">Мамандықтар</label>
                <button type="button" class="btn-selector" id="professionsBtn" onclick="selectProfessions()">
                    <span data-kk="Мамандықтарды таңдаңыз" data-ru="Выберите профессии">Мамандықтарды таңдаңыз</span>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7 10l5 5 5-5z"/>
                    </svg>
                </button>
                <div class="error-message" id="professionsError"></div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label data-kk="Күтілетін жалақы (бастап)" data-ru="Ожидаемая зарплата (от)">Күтілетін жалақы (бастап)</label>
                    <input type="number" id="expectedSalaryStart" placeholder="50000" min="0">
                </div>
                <div class="form-group">
                    <label data-kk="Күтілетін жалақы (дейін)" data-ru="Ожидаемая зарплата (до)">Күтілетін жалақы (дейін)</label>
                    <input type="number" id="expectedSalaryEnd" placeholder="100000" min="0">
                </div>
            </div>

            <div class="form-group">
                <label data-kk="Жұмыс кестесі" data-ru="График работы">Жұмыс кестесі</label>
                <button type="button" class="btn-selector" id="workScheduleBtn" onclick="selectWorkSchedule()">
                    <span data-kk="Жұмыс кестесін таңдаңыз" data-ru="Выберите график работы">Жұмыс кестесін таңдаңыз</span>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7 10l5 5 5-5z"/>
                    </svg>
                </button>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label data-kk="Іссапарға дайындық" data-ru="Готовность к командировкам">Іссапарға дайындық</label>
                    <select id="tripReadiness">
                        <option value="" data-kk="Таңдаңыз" data-ru="Выберите">Таңдаңыз</option>
                        <option value="READY" data-kk="Дайын" data-ru="Готов">Дайын</option>
                        <option value="SOMETIME" data-kk="Кейде" data-ru="Иногда">Кейде</option>
                        <option value="NOT_READY" data-kk="Дайын емес" data-ru="Не готов">Дайын емес</option>
                    </select>
                </div>
                <div class="form-group">
                    <label data-kk="Занятость" data-ru="Занятость">Занятость</label>
                    <button type="button" class="btn-selector" id="busynessBtn" onclick="selectBusyness()">
                        <span data-kk="Занятостын таңдаңыз" data-ru="Выберите занятость">Занятостын таңдаңыз</span>
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7 10l5 5 5-5z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="relocationReadiness">
                <label for="relocationReadiness" data-kk="Қоныс аударуға дайын" data-ru="Готов к переезду">Қоныс аударуға дайын</label>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="workPermit">
                <label for="workPermit" data-kk="Жұмыс рұқсаты бар" data-ru="Есть разрешение на работу">Жұмыс рұқсаты бар</label>
            </div>
        </div>

        <!-- Education Section -->
        <div class="section">
            <h2 class="section-title" data-kk="Білім" data-ru="Образование">Білім</h2>
            <div id="educationContainer">
                <!-- Education items will be added here -->
            </div>
            <button type="button" class="add-btn" onclick="addEducation()" data-kk="Білім қосу" data-ru="Добавить образование">Білім қосу</button>
        </div>

        <!-- Additional Courses Section -->
        <div class="section">
            <h2 class="section-title" data-kk="Қосымша курстар" data-ru="Дополнительные курсы">Қосымша курстар</h2>
            <div id="coursesContainer">
                <!-- Course items will be added here -->
            </div>
            <button type="button" class="add-btn" onclick="addCourse()" data-kk="Курс қосу" data-ru="Добавить курс">Курс қосу</button>
        </div>

        <!-- Work Experience Section -->
        <div class="section">
            <h2 class="section-title" data-kk="Жұмыс тәжірибесі" data-ru="Опыт работы">Жұмыс тәжірибесі</h2>
            <div id="workExperienceContainer">
                <!-- Work experience items will be added here -->
            </div>
            <button type="button" class="add-btn" onclick="addWorkExperience()" data-kk="Тәжірибе қосу" data-ru="Добавить опыт">Тәжірибе қосу</button>
        </div>

        <!-- Skills Section -->
        <div class="section">
            <h2 class="section-title" data-kk="Дағдылар" data-ru="Навыки">Дағдылар</h2>
            <div class="form-group">
                <button type="button" class="btn-selector" id="skillsBtn" onclick="selectSkills()">
                    <span data-kk="Дағдыларды таңдаңыз" data-ru="Выберите навыки">Дағдыларды таңдаңыз</span>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M7 10l5 5 5-5z"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Additional Information Section -->
        <div class="section">
            <h2 class="section-title" data-kk="Қосымша ақпарат" data-ru="Дополнительная информация">Қосымша ақпарат</h2>
            
            <div class="form-group">
                <label data-kk="Өзім туралы" data-ru="О себе">Өзім туралы</label>
                <textarea id="additionalInfo" rows="4" placeholder="Сіздің мамандығыңыз, тәжірибеңіз және мақсаттарыңыз туралы айтып беріңіз..."></textarea>
            </div>

            <!-- Social Networks -->
            <div class="form-group">
                <label data-kk="Әлеуметтік желілер" data-ru="Социальные сети">Әлеуметтік желілер</label>
                <div id="socialNetworksContainer">
                    <!-- Social network items will be added here -->
                </div>
                <button type="button" class="add-btn" onclick="addSocialNetwork()" data-kk="Әлеуметтік желі қосу" data-ru="Добавить соц. сеть">Әлеуметтік желі қосу</button>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="hasDriverLicense" onchange="handleDriverLicenseChange()">
                <label for="hasDriverLicense" data-kk="Жүргізуші куәлігі бар" data-ru="Есть водительские права">Жүргізуші куәлігі бар</label>
            </div>
            <div id="driverLicenseCategories" style="display: none; margin-top: 0.5rem;">
                <label data-kk="Категориялар" data-ru="Категории">Категориялар:</label>
                <div id="selectedCategories" style="color: #2d5a32; font-weight: 500; margin-top: 0.25rem;"></div>
                <button type="button" class="btn-outline" onclick="showDriverLicenseModal()" style="margin-top: 0.5rem; padding: 0.5rem 1rem;" data-kk="Категорияларды таңдау" data-ru="Выбрать категории">Категорияларды таңдау</button>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="bargain">
                <label for="bargain" data-kk="Жалақы туралы келіссөздер мүмкін" data-ru="Возможны переговоры по зарплате">Жалақы туралы келіссөздер мүмкін</label>
            </div>

            <div class="checkbox-group">
                <input type="checkbox" id="advance">
                <label for="advance" data-kk="Аванс қажет" data-ru="Требуется аванс">Аванс қажет</label>
            </div>
        </div>

        <button type="button" class="submit-btn" id="submitBtn" onclick="submitCV()">
            <span data-kk="Резюме жасау" data-ru="Создать резюме">Резюме жасау</span>
        </button>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="success-icon">✓</div>
            <h3 data-kk="Резюме сәтті жасалды!" data-ru="Резюме успешно создано!">Резюме сәтті жасалды!</h3>
            <p data-kk="Сіздің резюмеңіз жарияланды және жұмыс берушілер көре алады" data-ru="Ваше резюме опубликовано и доступно работодателям">Сіздің резюмеңіз жарияланды және жұмыс берушілер көре алады</p>
            <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                <button class="btn-outline" onclick="createAnother()" data-kk="Жаңа резюме" data-ru="Новое резюме">Жаңа резюме</button>
                <button class="btn" onclick="goToMain()" data-kk="Басты бетке" data-ru="На главную">Басты бетке</button>
            </div>
        </div>
    </div>

    <script>
        let currentLanguage = 'kk';
        let userData = {};
        let selectedData = {
            city: null,
            professions: [],
            skills: [],
            workSchedule: [],
            tripReadiness: null,
            busyness: []
        };
        let educationItems = [];
        let workExperienceItems = [];
        let courseItems = [];
        let socialNetworkItems = [];
        let userImageFile = null;
        let selectedDriverLicenses = [];

        // Dictionary data will be loaded from API
        let cities = [];
        let professions = [];
        let skills = [];
        let workScheduleOptions = [];
        let universities = [];
        let specialties = [];
        let educationTypes = [];
        let vehicleCategories = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            loadUserData();
            loadLanguage();
            loadDictionaries();
            initializeModalHandlers();
        });

        // Universal modal handler functions
        function initializeModalHandlers() {
            // ESC key handler for all modals
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    closeAnyOpenModal();
                }
            });

            // Outside click handler for all modals
            document.addEventListener('click', function(event) {
                const openModal = document.querySelector('.modal.show, .modal[style*="display: flex"]');
                if (openModal) {
                    const modalContent = openModal.querySelector('.modal-content');
                    // Only close if clicking outside the modal content (on the overlay)
                    if (event.target === openModal) {
                        closeAnyOpenModal();
                    }
                }
            });
        }

        function closeAnyOpenModal() {
            // Close success modal (static modal)
            const successModal = document.getElementById('successModal');
            if (successModal && successModal.classList.contains('show')) {
                successModal.classList.remove('show');
                return;
            }

            // Close city modal (dynamic modal)
            const cityModal = document.getElementById('cityModal');
            if (cityModal) {
                closeCityModal();
                return;
            }

            // Close profession modal (dynamic modal)
            const professionModal = document.getElementById('professionModal');
            if (professionModal) {
                closeProfessionModal();
                return;
            }

            // Close skills modal (dynamic modal)
            const skillsModal = document.getElementById('skillsModal');
            if (skillsModal) {
                closeSkillsModal();
                return;
            }

            // Close busyness modal (dynamic modal)
            const busynessModal = document.getElementById('busynessModal');
            if (busynessModal) {
                closeBusynessModal();
                return;
            }

            // Close work schedule modal (dynamic modal)
            const workScheduleModal = document.getElementById('workScheduleModal');
            if (workScheduleModal) {
                closeWorkScheduleModal();
                return;
            }

            // Close university modal (dynamic modal)
            const universityModal = document.getElementById('universityModal');
            if (universityModal) {
                closeUniversityModal();
                return;
            }

            // Close specialty modal (dynamic modal)
            const specialtyModal = document.getElementById('specialtyModal');
            if (specialtyModal) {
                closeSpecialtyModal();
                return;
            }

            // Close driver license modal (dynamic modal)
            const driverLicenseModal = document.getElementById('driverLicenseModal');
            if (driverLicenseModal) {
                closeDriverLicenseModal();
                return;
            }

            // Close any other dynamically created modals
            const dynamicModals = document.querySelectorAll('.modal[style*="display: flex"]');
            dynamicModals.forEach(modal => {
                modal.remove();
            });
        }

        function checkAuthentication() {
            const storedAuth = localStorage.getItem('stroyka_cv_auth');
            if (!storedAuth) {
                window.location.href = 'cv.html';
                return;
            }

            try {
                userData = JSON.parse(storedAuth);
                const twentyFourHours = 24 * 60 * 60 * 1000;
                
                if (!userData.isAuthenticated || 
                    !userData.timestamp || 
                    (Date.now() - userData.timestamp) > twentyFourHours) {
                    localStorage.removeItem('stroyka_cv_auth');
                    window.location.href = 'cv.html';
                }
            } catch (e) {
                localStorage.removeItem('stroyka_cv_auth');
                window.location.href = 'cv.html';
            }
        }

        function loadUserData() {
            if (userData.phone) {
                document.getElementById('phoneNumber').value = '+' + userData.phone;
            }
            
            // Set auth token for API calls
            if (userData.accessToken) {
                apiService.setAuthToken(userData.accessToken);
            }
        }

        function loadLanguage() {
            const savedLang = localStorage.getItem('stroyka_lang') || 'kk';
            changeLanguage(savedLang);
        }

        function changeLanguage(lang) {
            currentLanguage = lang;
            apiService.setLanguage(lang);
            document.querySelectorAll('[data-kk][data-ru]').forEach(element => {
                element.textContent = element.getAttribute('data-' + lang);
            });
            localStorage.setItem('stroyka_lang', lang);
        }

        async function loadDictionaries() {
            await Promise.all([
                loadCities(),
                loadProfessions(),
                loadSkills(),
                loadWorkSchedule(),
                loadUniversities(),
                loadSpecialties(),
                loadEducationTypes(),
                loadVehicleCategories()
            ]);
            // Multi-select initialization no longer needed - using modals
        }

        async function loadWorkSchedule() {
            try {
                workScheduleOptions = await apiService.getWorkSchedule();
                console.log('Work schedule options loaded:', workScheduleOptions.length);
                // Work schedule options loaded - ready for modal display
            } catch (error) {
                console.error('Error loading work schedule options:', error);
                // Fallback to basic options if API fails
                setFallbackWorkSchedule();
            }
        }

        function setFallbackWorkSchedule() {
            workScheduleOptions = [
                { code: "FULL", name: currentLanguage === 'kk' ? "Толық күн" : "Полный день" },
                { code: "SHIFT", name: currentLanguage === 'kk' ? "Ауысымдық" : "Сменный" },
                { code: "FLEXIBLE", name: currentLanguage === 'kk' ? "Икемді кесте" : "Гибкий график" },
                { code: "REMOTE", name: currentLanguage === 'kk' ? "Қашықтан жұмыс" : "Удаленная работа" }
            ];
            // Work schedule options set - ready for modal display
        }





        async function loadCities() {
            try {
                cities = await apiService.getCities();
                console.log('Cities loaded:', cities.length);
            } catch (error) {
                console.error('Error loading cities:', error);
                // Fallback to basic cities if API fails
                cities = [
                    { code: "110000000", name: "Астана" },
                    { code: "190000000", name: "Алматы" },
                    { code: "310000000", name: "Шымкент" }
                ];
            }
        }

        async function loadProfessions() {
            try {
                professions = await apiService.getProfessions();
                console.log('Professions loaded:', professions.length);
            } catch (error) {
                console.error('Error loading professions:', error);
                // Fallback to basic professions if API fails
                professions = [
                    { id: 1, name: "Құрылысшы" },
                    { id: 2, name: "Крановщик" },
                    { id: 3, name: "Сварщик" },
                    { id: 4, name: "Электрик" },
                    { id: 5, name: "Слесарь" },
                    { id: 6, name: "Монтажник" },
                    { id: 7, name: "Отделочник" },
                    { id: 8, name: "Прораб" }
                ];
            }
        }

        async function loadSkills() {
            try {
                skills = await apiService.getSkills();
                console.log('Skills loaded:', skills.length);
            } catch (error) {
                console.error('Error loading skills:', error);
                // Fallback to basic skills if API fails
                skills = [
                    { id: 1, name: "Сварка" },
                    { id: 2, name: "Электромонтаж" },
                    { id: 3, name: "Бетонные работы" },
                    { id: 4, name: "Кровельные работы" },
                    { id: 5, name: "Отделочные работы" },
                    { id: 6, name: "Работа на высоте" },
                    { id: 7, name: "Чтение чертежей" },
                    { id: 8, name: "Управление краном" }
                ];
            }
        }

        async function loadUniversities() {
            try {
                universities = await apiService.getUniversities();
                console.log('Universities loaded:', universities.length);
            } catch (error) {
                console.error('Error loading universities:', error);
                // Fallback to basic universities if API fails
                universities = [
                    { id: 1, name: "Евразийский национальный университет им. Л.Н.Гумилева" },
                    { id: 2, name: "Казахская национальная академия искусств им. Т. Жургенова" },
                    { id: 3, name: "Казахский национальный университет им. аль-Фараби" }
                ];
            }
        }

        async function loadSpecialties() {
            try {
                specialties = await apiService.getSpecialties();
                console.log('Specialties loaded:', specialties.length);
            } catch (error) {
                console.error('Error loading specialties:', error);
                // Fallback to basic specialties if API fails
                specialties = [
                    { id: 1, name: "Дошкольное обучение и воспитание" },
                    { id: 2, name: "Педагогика и методика начального обучения" },
                    { id: 3, name: "Строительство" },
                    { id: 4, name: "Архитектура" }
                ];
            }
        }

        async function loadEducationTypes() {
            try {
                educationTypes = await apiService.getEducationTypes();
                console.log('Education types loaded:', educationTypes.length);
            } catch (error) {
                console.error('Error loading education types:', error);
                // Fallback to basic education types if API fails
                educationTypes = [
                    { code: "SECONDARY_EDUCATION", name: "Среднее образование" },
                    { code: "HIGHER_EDUCATION", name: "Высшее образование" },
                    { code: "POSTGRADUATE_EDUCATION", name: "Послевузовское образование" }
                ];
            }
        }

        async function loadVehicleCategories() {
            try {
                vehicleCategories = await apiService.getVehicleCategories();
                console.log('Vehicle categories loaded:', vehicleCategories.length);
            } catch (error) {
                console.error('Error loading vehicle categories:', error);
                // Fallback to basic vehicle categories if API fails
                vehicleCategories = [
                    { category: "A", description: "Мотоциклдер" },
                    { category: "A1", description: "Жеңіл мотоциклдер" },
                    { category: "B", description: "Жеңіл автомобильдер" },
                    { category: "C", description: "Жүк көліктері" }
                ];
            }
        }

        function selectCity() {
            if (cities.length === 0) {
                alert(currentLanguage === 'kk' ? 'Қалалар жүктелуде...' : 'Загрузка городов...');
                return;
            }
            
            // Create a simple modal for city selection
            showCityModal();
        }

        function showCityModal() {
            // Create modal HTML
            const modalHTML = `
                <div class="modal show" id="cityModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 500px; max-height: 70vh;">
                        <h3 style="margin-bottom: 1rem;" data-kk="Қаланы таңдаңыз" data-ru="Выберите город">Қаланы таңдаңыз</h3>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="citySearch" placeholder="${currentLanguage === 'kk' ? 'Қаланы іздеу...' : 'Поиск города...'}" 
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 1rem;">
                                </div>
                        <div id="cityList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px;">
                            ${renderCityOptions(cities)}
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                            <button class="btn-outline" onclick="closeCityModal()" style="flex: 1; min-height: 44px; font-size: 1rem;" data-kk="Жабу" data-ru="Закрыть">Жабу</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Initialize search functionality
            const searchInput = document.getElementById('citySearch');
            searchInput.addEventListener('input', function() {
                const searchText = this.value.toLowerCase();
                const filteredCities = cities.filter(city => 
                    city.name.toLowerCase().includes(searchText)
                );
                document.getElementById('cityList').innerHTML = renderCityOptions(filteredCities);
                addCityOptionHoverEffects();
            });
            
            // Add initial hover effects
            addCityOptionHoverEffects();
            
            // Focus search input
            setTimeout(() => searchInput.focus(), 100);
            
            // Update text content for current language
            document.querySelectorAll('#cityModal [data-kk][data-ru]').forEach(element => {
                element.textContent = element.getAttribute('data-' + currentLanguage);
            });
        }

        function renderCityOptions(cityList) {
            return cityList.map(city => `
                <div class="city-option" style="padding: 0.75rem; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.3s;" 
                     onclick="selectCityOption('${city.code}', '${city.name.replace(/'/g, "\\'")}')">
                    ${city.name}
                </div>
            `).join('');
        }

        function addCityOptionHoverEffects() {
            document.querySelectorAll('.city-option').forEach(option => {
                option.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8f9fa';
                });
                option.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            });
        }

        function selectCityOption(code, name) {
            const city = cities.find(c => c.code === code);
            if (city) {
                selectedData.city = city;
                document.getElementById('cityBtn').querySelector('span').textContent = city.name;
                document.getElementById('cityBtn').classList.add('selected');
                document.getElementById('cityError').style.display = 'none';
                document.getElementById('cityBtn').classList.remove('error');
            }
            closeCityModal();
        }

        function closeCityModal() {
            const modal = document.getElementById('cityModal');
            if (modal) {
                modal.remove();
            }
        }

        function selectProfessions() {
            if (professions.length === 0) {
                alert(currentLanguage === 'kk' ? 'Мамандықтар жүктелуде...' : 'Загрузка профессий...');
                return;
            }
            
            showProfessionModal();
        }

        function showProfessionModal() {
            // Create modal HTML
            const modalHTML = `
                <div class="modal show" id="professionModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 500px; max-height: 70vh;">
                        <h3 style="margin-bottom: 1rem;" data-kk="Мамандықтарды таңдаңыз" data-ru="Выберите профессии">Мамандықтарды таңдаңыз</h3>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="professionSearch" placeholder="${currentLanguage === 'kk' ? 'Мамандықты іздеу...' : 'Поиск профессии...'}" 
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 1rem;">
                        </div>
                        <div id="professionList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px;">
                            ${renderProfessionOptions(professions)}
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                            <button class="btn-outline" onclick="closeProfessionModal()" style="flex: 1; min-height: 44px; font-size: 1rem;" data-kk="Жабу" data-ru="Закрыть">Жабу</button>
                            <button class="btn" onclick="confirmProfessionSelection()" style="flex: 1; min-height: 44px; font-size: 1rem;" data-kk="Таңдау" data-ru="Выбрать">Таңдау</button>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;" data-kk="Бірнеше мамандық таңдай аласыз" data-ru="Можно выбрать несколько профессий">
                            ${currentLanguage === 'kk' ? 'Бірнеше мамандық таңдай аласыз' : 'Можно выбрать несколько профессий'}
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Initialize search functionality
            const searchInput = document.getElementById('professionSearch');
            searchInput.addEventListener('input', function() {
                const searchText = this.value.toLowerCase();
                const filteredProfessions = professions.filter(profession => 
                    profession.name.toLowerCase().includes(searchText)
                );
                document.getElementById('professionList').innerHTML = renderProfessionOptions(filteredProfessions);
                addProfessionOptionClickEffects();
            });
            
            // Add initial click effects and restore selections
            addProfessionOptionClickEffects();
            restoreProfessionSelections();
            
            // Focus search input
            setTimeout(() => searchInput.focus(), 100);
            
            // Update text content for current language
            document.querySelectorAll('#professionModal [data-kk][data-ru]').forEach(element => {
                element.textContent = element.getAttribute('data-' + currentLanguage);
            });
        }

        function renderProfessionOptions(professionList) {
            const selectedIds = selectedData.professions.map(p => p.id);
            
            return professionList.map(profession => {
                const isSelected = selectedIds.includes(profession.id);
                const selectedAttr = isSelected ? 'data-selected="true"' : 'data-selected="false"';
                const selectedStyle = isSelected ? 'background-color: #e8f5e8; color: #2d5a32; font-weight: 600;' : '';
                
                return `
                    <div class="profession-option" style="padding: 0.75rem; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; ${selectedStyle}" 
                         data-id="${profession.id}" data-name="${profession.name.replace(/"/g, '&quot;')}" ${selectedAttr}>
                        <span style="width: 100%;">${profession.name}</span>
                    </div>
                `;
            }).join('');
        }

        function addProfessionOptionClickEffects() {
            document.querySelectorAll('.profession-option').forEach(option => {
                option.addEventListener('click', function() {
                    const isSelected = this.dataset.selected === 'true';
                    const professionId = parseInt(this.dataset.id);
                    const professionName = this.dataset.name;
                    
                    if (isSelected) {
                        // Deselect - remove from selectedData.professions
                        this.dataset.selected = 'false';
                        this.style.backgroundColor = '';
                        this.style.color = '';
                        this.style.fontWeight = '';
                        selectedData.professions = selectedData.professions.filter(p => p.id !== professionId);
                    } else {
                        // Select - add to selectedData.professions
                        this.dataset.selected = 'true';
                        this.style.backgroundColor = '#e8f5e8';
                        this.style.color = '#2d5a32';
                        this.style.fontWeight = '600';
                        selectedData.professions.push({ id: professionId, name: professionName });
                    }
                });
                
                option.addEventListener('mouseenter', function() {
                    if (this.dataset.selected !== 'true') {
                        this.style.backgroundColor = '#f8f9fa';
                    }
                });
                
                option.addEventListener('mouseleave', function() {
                    if (this.dataset.selected !== 'true') {
                        this.style.backgroundColor = '';
                    }
                });
            });
        }

        function restoreProfessionSelections() {
            const selectedIds = selectedData.professions.map(p => p.id);
            document.querySelectorAll('.profession-option').forEach(option => {
                const professionId = parseInt(option.dataset.id);
                
                if (selectedIds.includes(professionId)) {
                    option.dataset.selected = 'true';
                    option.style.backgroundColor = '#e8f5e8';
                    option.style.color = '#2d5a32';
                    option.style.fontWeight = '600';
                } else {
                    option.dataset.selected = 'false';
                    option.style.backgroundColor = '';
                    option.style.color = '';
                    option.style.fontWeight = '';
                }
            });
        }

        function confirmProfessionSelection() {
            const selectedOptions = document.querySelectorAll('.profession-option[data-selected="true"]');
            selectedData.professions = [];
            
            selectedOptions.forEach(option => {
                selectedData.professions.push({
                    id: parseInt(option.dataset.id),
                    name: option.dataset.name
                });
            });
                
                if (selectedData.professions.length > 0) {
                    const displayText = selectedData.professions.map(p => p.name).join(', ');
                    document.getElementById('professionsBtn').querySelector('span').textContent = displayText;
                    document.getElementById('professionsBtn').classList.add('selected');
                document.getElementById('professionsError').style.display = 'none';
                document.getElementById('professionsBtn').classList.remove('error');
            } else {
                document.getElementById('professionsBtn').querySelector('span').textContent = 
                    currentLanguage === 'kk' ? 'Мамандықтарды таңдаңыз' : 'Выберите профессии';
                document.getElementById('professionsBtn').classList.remove('selected');
            }
            
            closeProfessionModal();
        }

        function closeProfessionModal() {
            const modal = document.getElementById('professionModal');
            if (modal) {
                modal.remove();
            }
        }

        function selectSkills() {
            if (skills.length === 0) {
                alert(currentLanguage === 'kk' ? 'Дағдылар жүктелуде...' : 'Загрузка навыков...');
                return;
            }
            
            showSkillsModal();
        }

        function showSkillsModal() {
            // Create modal HTML
            const modalHTML = `
                <div class="modal show" id="skillsModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 500px; max-height: 70vh;">
                        <h3 style="margin-bottom: 1rem;" data-kk="Дағдыларды таңдаңыз" data-ru="Выберите навыки">Дағдыларды таңдаңыз</h3>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="skillsSearch" placeholder="${currentLanguage === 'kk' ? 'Дағдыны іздеу...' : 'Поиск навыка...'}" 
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 1rem;">
                        </div>
                        <div id="skillsList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px;">
                            ${renderSkillsOptions(skills)}
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                            <button class="btn-outline" onclick="closeSkillsModal()" style="flex: 1; min-height: 44px; font-size: 1rem;" data-kk="Жабу" data-ru="Закрыть">Жабу</button>
                            <button class="btn" onclick="confirmSkillsSelection()" style="flex: 1; min-height: 44px; font-size: 1rem;" data-kk="Таңдау" data-ru="Выбрать">Таңдау</button>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;" data-kk="Бірнеше дағды таңдай аласыз" data-ru="Можно выбрать несколько навыков">
                            ${currentLanguage === 'kk' ? 'Бірнеше дағды таңдай аласыз' : 'Можно выбрать несколько навыков'}
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Initialize search functionality
            const searchInput = document.getElementById('skillsSearch');
            searchInput.addEventListener('input', function() {
                const searchText = this.value.toLowerCase();
                const filteredSkills = skills.filter(skill => 
                    skill.name.toLowerCase().includes(searchText)
                );
                document.getElementById('skillsList').innerHTML = renderSkillsOptions(filteredSkills);
                addSkillsOptionClickEffects();
            });
            
            // Add initial click effects
            addSkillsOptionClickEffects();
            
            // Focus search input
            setTimeout(() => searchInput.focus(), 100);
            
            // Update text content for current language
            document.querySelectorAll('#skillsModal [data-kk][data-ru]').forEach(element => {
                element.textContent = element.getAttribute('data-' + currentLanguage);
            });
        }

        function renderSkillsOptions(skillsList) {
            const selectedIds = selectedData.skills.map(s => s.id);
            
            return skillsList.map(skill => {
                const isSelected = selectedIds.includes(skill.id);
                const selectedAttr = isSelected ? 'data-selected="true"' : 'data-selected="false"';
                const selectedStyle = isSelected ? 'background-color: #e8f5e8; color: #2d5a32; font-weight: 600;' : '';
                
                return `
                    <div class="skills-option" style="padding: 0.75rem; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; ${selectedStyle}" 
                         data-id="${skill.id}" data-name="${skill.name.replace(/"/g, '&quot;')}" ${selectedAttr}>
                        <span style="width: 100%;">${skill.name}</span>
                    </div>
                `;
            }).join('');
        }

        function addSkillsOptionClickEffects() {
            document.querySelectorAll('.skills-option').forEach(option => {
                option.addEventListener('click', function() {
                    const isSelected = this.dataset.selected === 'true';
                    const skillId = parseInt(this.dataset.id);
                    const skillName = this.dataset.name;
                    
                    if (isSelected) {
                        // Deselect
                        this.dataset.selected = 'false';
                        this.style.backgroundColor = '';
                        this.style.color = '';
                        this.style.fontWeight = '';
                        selectedData.skills = selectedData.skills.filter(s => s.id !== skillId);
                    } else {
                        // Select
                        this.dataset.selected = 'true';
                        this.style.backgroundColor = '#e8f5e8';
                        this.style.color = '#2d5a32';
                        this.style.fontWeight = '600';
                        selectedData.skills.push({ id: skillId, name: skillName });
                    }
                });
                
                option.addEventListener('mouseenter', function() {
                    if (this.dataset.selected !== 'true') {
                        this.style.backgroundColor = '#f8f9fa';
                    }
                });
                
                option.addEventListener('mouseleave', function() {
                    if (this.dataset.selected !== 'true') {
                        this.style.backgroundColor = '';
                    }
                });
            });
        }

        function confirmSkillsSelection() {
            const selectedOptions = document.querySelectorAll('.skills-option[data-selected="true"]');
            selectedData.skills = [];
            
            selectedOptions.forEach(option => {
                selectedData.skills.push({
                    id: parseInt(option.dataset.id),
                    name: option.dataset.name
                });
            });
                
                if (selectedData.skills.length > 0) {
                    const displayText = selectedData.skills.map(s => s.name).join(', ');
                    document.getElementById('skillsBtn').querySelector('span').textContent = displayText;
                    document.getElementById('skillsBtn').classList.add('selected');
            } else {
                document.getElementById('skillsBtn').querySelector('span').textContent = 
                    currentLanguage === 'kk' ? 'Дағдыларды таңдаңыз' : 'Выберите навыки';
                document.getElementById('skillsBtn').classList.remove('selected');
            }
            
            closeSkillsModal();
        }

        function closeSkillsModal() {
            const modal = document.getElementById('skillsModal');
            if (modal) {
                modal.remove();
            }
        }

        function selectWorkSchedule() {
            showWorkScheduleModal();
        }

        function showWorkScheduleModal() {
            const modalHTML = `
                <div class="modal show" id="workScheduleModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 500px; max-height: 70vh;">
                        <h3 style="margin-bottom: 1rem;" data-kk="Жұмыс кестесін таңдаңыз" data-ru="Выберите график работы">Жұмыс кестесін таңдаңыз</h3>
                        <div id="workScheduleList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px;">
                            ${renderWorkScheduleOptions(workScheduleOptions)}
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                            <button class="btn-outline" onclick="closeWorkScheduleModal()" style="flex: 1; min-height: 44px; font-size: 1rem;" data-kk="Жабу" data-ru="Закрыть">Жабу</button>
                            <button class="btn" onclick="confirmWorkScheduleSelection()" style="flex: 1; min-height: 44px; font-size: 1rem;" data-kk="Таңдау" data-ru="Выбрать">Таңдау</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            addWorkScheduleOptionClickEffects();
            
            document.querySelectorAll('#workScheduleModal [data-kk][data-ru]').forEach(element => {
                element.textContent = element.getAttribute('data-' + currentLanguage);
            });
        }

        function renderWorkScheduleOptions(workScheduleList) {
            const selectedCodes = selectedData.workSchedule;
            
            return workScheduleList.map(schedule => {
                const isSelected = selectedCodes.includes(schedule.code);
                const selectedAttr = isSelected ? 'data-selected="true"' : 'data-selected="false"';
                const selectedStyle = isSelected ? 'background-color: #e8f5e8; color: #2d5a32; font-weight: 600;' : '';
                
                return `
                    <div class="workschedule-option" style="padding: 0.75rem; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; ${selectedStyle}" 
                         data-code="${schedule.code}" data-name="${schedule.name.replace(/"/g, '&quot;')}" ${selectedAttr}>
                        <span style="width: 100%;">${schedule.name}</span>
                    </div>
                `;
            }).join('');
        }

        function addWorkScheduleOptionClickEffects() {
            document.querySelectorAll('.workschedule-option').forEach(option => {
                option.addEventListener('click', function() {
                    const isSelected = this.dataset.selected === 'true';
                    const scheduleCode = this.dataset.code;
                    
                    if (isSelected) {
                        // Deselect
                        this.dataset.selected = 'false';
                        this.style.backgroundColor = '';
                        this.style.color = '';
                        this.style.fontWeight = '';
                        selectedData.workSchedule = selectedData.workSchedule.filter(s => s !== scheduleCode);
                    } else {
                        // Select
                        this.dataset.selected = 'true';
                        this.style.backgroundColor = '#e8f5e8';
                        this.style.color = '#2d5a32';
                        this.style.fontWeight = '600';
                        selectedData.workSchedule.push(scheduleCode);
                    }
                });
                
                option.addEventListener('mouseenter', function() {
                    if (this.dataset.selected !== 'true') {
                        this.style.backgroundColor = '#f8f9fa';
                    }
                });
                
                option.addEventListener('mouseleave', function() {
                    if (this.dataset.selected !== 'true') {
                        this.style.backgroundColor = '';
                    }
                });
            });
        }

        function confirmWorkScheduleSelection() {
            if (selectedData.workSchedule.length > 0) {
                const displayText = selectedData.workSchedule.map(code => {
                    const option = workScheduleOptions.find(opt => opt.code === code);
                    return option ? option.name : code;
                }).join(', ');
                
                document.getElementById('workScheduleBtn').querySelector('span').textContent = displayText;
                document.getElementById('workScheduleBtn').classList.add('selected');
            } else {
                document.getElementById('workScheduleBtn').querySelector('span').textContent = 
                    currentLanguage === 'kk' ? 'Жұмыс кестесін таңдаңыз' : 'Выберите график работы';
                document.getElementById('workScheduleBtn').classList.remove('selected');
            }
            
            closeWorkScheduleModal();
        }

        function closeWorkScheduleModal() {
            const modal = document.getElementById('workScheduleModal');
            if (modal) {
                modal.remove();
            }
        }

        function selectBusyness() {
            showBusynessModal();
        }

        function showBusynessModal() {
            const busynessOptions = [
                { code: "FULL", name: currentLanguage === 'kk' ? "Толық" : "Полная" },
                { code: "PARTIAL", name: currentLanguage === 'kk' ? "Ішінара" : "Частичная" },
                { code: "PROJECT", name: currentLanguage === 'kk' ? "Жоба" : "Проектная" },
                { code: "INTERNSHIP", name: currentLanguage === 'kk' ? "Тәжірибе" : "Стажировка" },
                { code: "REMOTE", name: currentLanguage === 'kk' ? "Қашықтан" : "Удаленная" }
            ];

            const modalHTML = `
                <div class="modal show" id="busynessModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 500px; max-height: 70vh;">
                        <h3 style="margin-bottom: 1rem;" data-kk="Занятостын таңдаңыз" data-ru="Выберите занятость">Занятостын таңдаңыз</h3>
                        <div id="busynessList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px;">
                            ${renderBusynessOptions(busynessOptions)}
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                            <button class="btn-outline" onclick="closeBusynessModal()" style="flex: 1; min-height: 44px; font-size: 1rem;" data-kk="Жабу" data-ru="Закрыть">Жабу</button>
                            <button class="btn" onclick="confirmBusynessSelection()" style="flex: 1; min-height: 44px; font-size: 1rem;" data-kk="Таңдау" data-ru="Выбрать">Таңдау</button>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;" data-kk="Бірнеше occupancy таңдай аласыз" data-ru="Можно выбрать несколько типов занятости">
                            ${currentLanguage === 'kk' ? 'Бірнеше occupancy таңдай аласыз' : 'Можно выбрать несколько типов занятости'}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            addBusynessOptionClickEffects();
            
            document.querySelectorAll('#busynessModal [data-kk][data-ru]').forEach(element => {
                element.textContent = element.getAttribute('data-' + currentLanguage);
            });
        }

        function renderBusynessOptions(busynessList) {
            const selectedCodes = selectedData.busyness;
            
            return busynessList.map(busyness => {
                const isSelected = selectedCodes.includes(busyness.code);
                const selectedAttr = isSelected ? 'data-selected="true"' : 'data-selected="false"';
                const selectedStyle = isSelected ? 'background-color: #e8f5e8; color: #2d5a32; font-weight: 600;' : '';
                
                return `
                    <div class="busyness-option" style="padding: 0.75rem; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; ${selectedStyle}" 
                         data-code="${busyness.code}" data-name="${busyness.name.replace(/"/g, '&quot;')}" ${selectedAttr}>
                        <span style="width: 100%;">${busyness.name}</span>
                    </div>
                `;
            }).join('');
        }

        function addBusynessOptionClickEffects() {
            document.querySelectorAll('.busyness-option').forEach(option => {
                option.addEventListener('click', function() {
                    const isSelected = this.dataset.selected === 'true';
                    const busynessCode = this.dataset.code;
                    
                    if (isSelected) {
                        // Deselect
                        this.dataset.selected = 'false';
                        this.style.backgroundColor = '';
                        this.style.color = '';
                        this.style.fontWeight = '';
                        selectedData.busyness = selectedData.busyness.filter(b => b !== busynessCode);
                    } else {
                        // Select
                        this.dataset.selected = 'true';
                        this.style.backgroundColor = '#e8f5e8';
                        this.style.color = '#2d5a32';
                        this.style.fontWeight = '600';
                        selectedData.busyness.push(busynessCode);
                    }
                });
                
                option.addEventListener('mouseenter', function() {
                    if (this.dataset.selected !== 'true') {
                        this.style.backgroundColor = '#f8f9fa';
                    }
                });
                
                option.addEventListener('mouseleave', function() {
                    if (this.dataset.selected !== 'true') {
                        this.style.backgroundColor = '';
                    }
                });
            });
        }

        function confirmBusynessSelection() {
            if (selectedData.busyness.length > 0) {
                const busynessOptions = [
                    { code: "FULL", name: currentLanguage === 'kk' ? "Толық" : "Полная" },
                    { code: "PARTIAL", name: currentLanguage === 'kk' ? "Ішінара" : "Частичная" },
                    { code: "PROJECT", name: currentLanguage === 'kk' ? "Жоба" : "Проектная" },
                    { code: "INTERNSHIP", name: currentLanguage === 'kk' ? "Тәжірибе" : "Стажировка" },
                    { code: "REMOTE", name: currentLanguage === 'kk' ? "Қашықтан" : "Удаленная" }
                ];
                
                const displayText = selectedData.busyness.map(code => {
                    const option = busynessOptions.find(opt => opt.code === code);
                    return option ? option.name : code;
                }).join(', ');
                
                document.getElementById('busynessBtn').querySelector('span').textContent = displayText;
                document.getElementById('busynessBtn').classList.add('selected');
            } else {
                document.getElementById('busynessBtn').querySelector('span').textContent = 
                    currentLanguage === 'kk' ? 'Занятостын таңдаңыз' : 'Выберите занятость';
                document.getElementById('busynessBtn').classList.remove('selected');
            }
            
            closeBusynessModal();
        }

        function closeBusynessModal() {
            const modal = document.getElementById('busynessModal');
            if (modal) {
                modal.remove();
            }
        }

        function toggleCustomUniversity(index) {
            const checkbox = document.getElementById(`customUniversity_${index}`);
            const universityBtn = document.getElementById(`universityBtn_${index}`);
            const universityOther = document.getElementById(`universityOther_${index}`);
            
            if (checkbox.checked) {
                universityBtn.style.display = 'none';
                universityOther.style.display = 'block';
                universityOther.focus();
                // Clear selected university
                if (educationItems[index]) {
                    educationItems[index].selectedUniversity = null;
                }
                universityBtn.classList.remove('selected');
                universityBtn.querySelector('span').textContent = 
                    currentLanguage === 'kk' ? 'Университетті таңдаңыз' : 'Выберите университет';
            } else {
                universityBtn.style.display = 'flex';
                universityOther.style.display = 'none';
                universityOther.value = '';
            }
        }

        function toggleCustomSpecialty(index) {
            const checkbox = document.getElementById(`customSpecialty_${index}`);
            const specialtyBtn = document.getElementById(`specialtyBtn_${index}`);
            const specialtyOther = document.getElementById(`specialtyOther_${index}`);
            
            if (checkbox.checked) {
                specialtyBtn.style.display = 'none';
                specialtyOther.style.display = 'block';
                specialtyOther.focus();
                // Clear selected specialty
                if (educationItems[index]) {
                    educationItems[index].selectedSpecialty = null;
                }
                specialtyBtn.classList.remove('selected');
                specialtyBtn.querySelector('span').textContent = 
                    currentLanguage === 'kk' ? 'Мамандықты таңдаңыз' : 'Выберите специальность';
            } else {
                specialtyBtn.style.display = 'flex';
                specialtyOther.style.display = 'none';
                specialtyOther.value = '';
            }
        }

        function selectUniversity(index) {
            if (universities.length === 0) {
                alert(currentLanguage === 'kk' ? 'Университеттер жүктелуде...' : 'Загрузка университетов...');
                return;
            }
            
            currentEducationIndex = index;
            showUniversityModal();
        }

        function selectSpecialty(index) {
            if (specialties.length === 0) {
                alert(currentLanguage === 'kk' ? 'Мамандықтар жүктелуде...' : 'Загрузка специальностей...');
                return;
            }
            
            currentEducationIndex = index;
            showSpecialtyModal();
        }

        let currentEducationIndex = null;

        function showUniversityModal() {
            const modalHTML = `
                <div class="modal show" id="universityModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 500px; max-height: 70vh;">
                        <h3 style="margin-bottom: 1rem;" data-kk="Университетті таңдаңыз" data-ru="Выберите университет">Университетті таңдаңыз</h3>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="universitySearch" placeholder="${currentLanguage === 'kk' ? 'Университетті іздеу...' : 'Поиск университета...'}" 
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 1rem;">
                        </div>
                        <div id="universityList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px;">
                            ${renderUniversityOptions(universities)}
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                            <button class="btn-outline" onclick="closeUniversityModal()" style="flex: 1; min-height: 44px; font-size: 1rem;" data-kk="Жабу" data-ru="Закрыть">Жабу</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            const searchInput = document.getElementById('universitySearch');
            searchInput.addEventListener('input', function() {
                const searchText = this.value.toLowerCase();
                const filteredUniversities = universities.filter(university => 
                    university.name.toLowerCase().includes(searchText)
                );
                document.getElementById('universityList').innerHTML = renderUniversityOptions(filteredUniversities);
                addUniversityOptionHoverEffects();
            });
            
            addUniversityOptionHoverEffects();
            setTimeout(() => searchInput.focus(), 100);
            
            document.querySelectorAll('#universityModal [data-kk][data-ru]').forEach(element => {
                element.textContent = element.getAttribute('data-' + currentLanguage);
            });
        }

        function renderUniversityOptions(universityList) {
            return universityList.map(university => `
                <div class="university-option" style="padding: 0.75rem; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.3s;" 
                     onclick="selectUniversityOption(${university.id}, '${university.name.replace(/'/g, "\\'")}')">
                    ${university.name}
                </div>
            `).join('');
        }

        function addUniversityOptionHoverEffects() {
            document.querySelectorAll('.university-option').forEach(option => {
                option.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8f9fa';
                });
                option.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            });
        }

        function selectUniversityOption(id, name) {
            const university = universities.find(u => u.id === id);
            if (university && currentEducationIndex !== null) {
                educationItems[currentEducationIndex].selectedUniversity = university;
                const btn = document.getElementById(`universityBtn_${currentEducationIndex}`);
                btn.querySelector('span').textContent = university.name;
                btn.classList.add('selected');
            }
            closeUniversityModal();
        }

        function closeUniversityModal() {
            const modal = document.getElementById('universityModal');
            if (modal) {
                modal.remove();
            }
            currentEducationIndex = null;
        }

        function showSpecialtyModal() {
            const modalHTML = `
                <div class="modal show" id="specialtyModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 500px; max-height: 70vh;">
                        <h3 style="margin-bottom: 1rem;" data-kk="Мамандықты таңдаңыз" data-ru="Выберите специальность">Мамандықты таңдаңыз</h3>
                        <div style="margin-bottom: 1rem;">
                            <input type="text" id="specialtySearch" placeholder="${currentLanguage === 'kk' ? 'Мамандықты іздеу...' : 'Поиск специальности...'}" 
                                style="width: 100%; padding: 0.75rem; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 1rem;">
                        </div>
                        <div id="specialtyList" style="max-height: 300px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px;">
                            ${renderSpecialtyOptions(specialties)}
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                            <button class="btn-outline" onclick="closeSpecialtyModal()" style="flex: 1; min-height: 44px; font-size: 1rem;" data-kk="Жабу" data-ru="Закрыть">Жабу</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            const searchInput = document.getElementById('specialtySearch');
            searchInput.addEventListener('input', function() {
                const searchText = this.value.toLowerCase();
                const filteredSpecialties = specialties.filter(specialty => 
                    specialty.name.toLowerCase().includes(searchText)
                );
                document.getElementById('specialtyList').innerHTML = renderSpecialtyOptions(filteredSpecialties);
                addSpecialtyOptionHoverEffects();
            });
            
            addSpecialtyOptionHoverEffects();
            setTimeout(() => searchInput.focus(), 100);
            
            document.querySelectorAll('#specialtyModal [data-kk][data-ru]').forEach(element => {
                element.textContent = element.getAttribute('data-' + currentLanguage);
            });
        }

        function renderSpecialtyOptions(specialtyList) {
            return specialtyList.map(specialty => `
                <div class="specialty-option" style="padding: 0.75rem; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.3s;" 
                     onclick="selectSpecialtyOption(${specialty.id}, '${specialty.name.replace(/'/g, "\\'")}')">
                    ${specialty.name}
                </div>
            `).join('');
        }

        function addSpecialtyOptionHoverEffects() {
            document.querySelectorAll('.specialty-option').forEach(option => {
                option.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8f9fa';
                });
                option.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = '';
                });
            });
        }

        function selectSpecialtyOption(id, name) {
            const specialty = specialties.find(s => s.id === id);
            if (specialty && currentEducationIndex !== null) {
                educationItems[currentEducationIndex].selectedSpecialty = specialty;
                const btn = document.getElementById(`specialtyBtn_${currentEducationIndex}`);
                btn.querySelector('span').textContent = specialty.name;
                btn.classList.add('selected');
            }
            closeSpecialtyModal();
        }

        function closeSpecialtyModal() {
            const modal = document.getElementById('specialtyModal');
            if (modal) {
                modal.remove();
            }
            currentEducationIndex = null;
        }

        // Photo upload functions
        async function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert(currentLanguage === 'kk' ? 'Тек суреттер жүктей аласыз' : 'Можно загружать только изображения');
                return;
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert(currentLanguage === 'kk' ? 'Файл өлшемі 10MB-тан аспауы керек' : 'Размер файла не должен превышать 10MB');
                return;
            }

            try {
                // Show loading state
                const uploadArea = document.getElementById('photoUploadArea');
                uploadArea.innerHTML = '<div style="padding: 2rem;"><div class="spinner"></div><p>Жүктелуде...</p></div>';

                // Upload photo using existing uploadPhoto method
                const uploadResult = await apiService.uploadPhoto(file);
                
                if (uploadResult) {
                    userImageFile = uploadResult;
                    showPhotoPreview(uploadResult.url);
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error('Error uploading photo:', error);
                alert(currentLanguage === 'kk' ? 'Фото жүктеуде қате орын алды' : 'Ошибка при загрузке фото');
                resetPhotoUploadArea();
            }
        }

        function showPhotoPreview(imageUrl) {
            const preview = document.getElementById('photoPreview');
            const uploadArea = document.getElementById('photoUploadArea');
            const image = document.getElementById('photoImage');
            
            image.src = imageUrl;
            preview.style.display = 'block';
            uploadArea.style.display = 'none';
        }

        function removePhoto() {
            userImageFile = null;
            const preview = document.getElementById('photoPreview');
            const uploadArea = document.getElementById('photoUploadArea');
            
            preview.style.display = 'none';
            uploadArea.style.display = 'block';
            resetPhotoUploadArea();
        }

        function resetPhotoUploadArea() {
            const uploadArea = document.getElementById('photoUploadArea');
            uploadArea.innerHTML = `
                <input type="file" id="userPhoto" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">
                <div class="upload-placeholder" onclick="document.getElementById('userPhoto').click()">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="#ccc">
                        <path d="M12 2C13.1 2 14 2.9 14 4C14 5.1 13.1 6 12 6C10.9 6 10 5.1 10 4C10 2.9 10.9 2 12 2ZM21 9V7L15 1H5C3.89 1 3 1.89 3 3V21C3 22.1 3.89 23 5 23H19C20.1 23 21 22.1 21 21V9H21ZM19 21H5V19L8 16L11 19L14 16L19 21Z"/>
                    </svg>
                    <p data-kk="Фото жүктеу үшін басыңыз" data-ru="Нажмите для загрузки фото">Фото жүктеу үшін басыңыз</p>
                    <span data-kk="JPG, PNG форматы" data-ru="Формат JPG, PNG">JPG, PNG форматы</span>
                </div>
            `;
            
            // Update language content
            document.querySelectorAll('#photoUploadArea [data-kk][data-ru]').forEach(element => {
                element.textContent = element.getAttribute('data-' + currentLanguage);
            });
        }

        // Course management functions
        function addCourse() {
            const container = document.getElementById('coursesContainer');
            const index = courseItems.length;
            
            const courseHTML = `
                <div class="education-item" data-index="${index}">
                    <button type="button" class="remove-btn" onclick="removeCourse(${index})">×</button>
                    <div class="form-row">
                        <div class="form-group">
                            <label data-kk="Курс атауы" data-ru="Название курса">Курс атауы</label>
                            <input type="text" id="courseName_${index}" placeholder="${currentLanguage === 'kk' ? 'Мысалы: JavaScript негіздері' : 'Например: Основы JavaScript'}">
                        </div>
                        <div class="form-group">
                            <label data-kk="Сертификат" data-ru="Сертификат">Сертификат</label>
                            <div class="course-file-upload" id="courseFileUpload_${index}" onclick="triggerCourseFileUpload(${index})">
                                <input type="file" id="courseFile_${index}" style="display: none;" accept=".pdf,.jpg,.jpeg,.png" onchange="handleCourseFileUpload(${index}, event)">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="#666">
                                    <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                                </svg>
                                <div class="file-info" id="courseFileInfo_${index}">
                                    <span data-kk="Файл таңдаңыз" data-ru="Выберите файл">Файл таңдаңыз</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', courseHTML);
            courseItems.push({ 
                index,
                file: null
            });
            
            // Update language content
            document.querySelectorAll(`[data-index="${index}"] [data-kk][data-ru]`).forEach(element => {
                element.textContent = element.getAttribute('data-' + currentLanguage);
            });
        }

        function removeCourse(index) {
            const item = document.querySelector(`#coursesContainer [data-index="${index}"]`);
            if (item) {
                item.remove();
                courseItems = courseItems.filter(item => item.index !== index);
            }
        }

        function triggerCourseFileUpload(index) {
            document.getElementById(`courseFile_${index}`).click();
        }

        async function handleCourseFileUpload(index, event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
            if (!allowedTypes.includes(file.type)) {
                alert(currentLanguage === 'kk' ? 'Тек PDF, JPG, PNG файлдарын жүктей аласыз' : 'Можно загружать только PDF, JPG, PNG файлы');
                return;
            }

            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert(currentLanguage === 'kk' ? 'Файл өлшемі 10MB-тан аспауы керек' : 'Размер файла не должен превышать 10MB');
                return;
            }

            try {
                // Show loading state
                const fileInfo = document.getElementById(`courseFileInfo_${index}`);
                const fileUpload = document.getElementById(`courseFileUpload_${index}`);
                fileInfo.innerHTML = '<div class="spinner" style="width: 16px; height: 16px;"></div><span>Жүктелуде...</span>';

                // Upload file using existing uploadPhoto method (works for any file)
                const uploadResult = await apiService.uploadPhoto(file);
                
                if (uploadResult) {
                    // Store file data
                    const courseItem = courseItems.find(item => item.index === index);
                    if (courseItem) {
                        courseItem.file = uploadResult;
                    }
                    
                    // Update UI
                    fileUpload.classList.add('has-file');
                    fileInfo.className = 'file-info uploaded';
                    fileInfo.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9,20.42L2.79,14.21L5.62,11.38L9,14.77L18.88,4.88L21.71,7.71L9,20.42Z"/>
                        </svg>
                        <span>${file.name}</span>
                    `;
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                console.error('Error uploading file:', error);
                alert(currentLanguage === 'kk' ? 'Файл жүктеуде қате орын алды' : 'Ошибка при загрузке файла');
                
                // Reset file info
                const fileInfo = document.getElementById(`courseFileInfo_${index}`);
                fileInfo.className = 'file-info';
                fileInfo.innerHTML = `<span data-kk="Файл таңдаңыз" data-ru="Выберите файл">${currentLanguage === 'kk' ? 'Файл таңдаңыз' : 'Выберите файл'}</span>`;
            }
        }

        // Social Network management functions
        function addSocialNetwork() {
            const container = document.getElementById('socialNetworksContainer');
            const index = socialNetworkItems.length;
            
            const socialNetworkHTML = `
                <div class="education-item" data-index="${index}">
                    <button type="button" class="remove-btn" onclick="removeSocialNetwork(${index})">×</button>
                    <div class="form-row">
                        <div class="form-group">
                            <label data-kk="Платформа" data-ru="Платформа">Платформа</label>
                            <select id="socialNetworkType_${index}">
                                <option value="" data-kk="Таңдаңыз" data-ru="Выберите">Таңдаңыз</option>
                                <option value="INSTAGRAM">Instagram</option>
                                <option value="FACEBOOK">Facebook</option>
                                <option value="TELEGRAM">Telegram</option>
                                <option value="WHATSAPP">WhatsApp</option>
                                <option value="LINKEDIN">LinkedIn</option>
                                <option value="OTHER" data-kk="Басқа" data-ru="Другое">Басқа</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-kk="Атауы" data-ru="Название">Атауы</label>
                            <input type="text" id="socialNetworkName_${index}" placeholder="${currentLanguage === 'kk' ? '@username немесе атауы' : '@username или название'}">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group form-row-full">
                            <label data-kk="Сілтеме" data-ru="Ссылка">Сілтеме</label>
                            <input type="url" id="socialNetworkUrl_${index}" placeholder="https://...">
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', socialNetworkHTML);
            socialNetworkItems.push({ index });
            
            // Update language content
            document.querySelectorAll(`#socialNetworksContainer [data-index="${index}"] [data-kk][data-ru]`).forEach(element => {
                element.textContent = element.getAttribute('data-' + currentLanguage);
            });
        }

        function removeSocialNetwork(index) {
            const item = document.querySelector(`#socialNetworksContainer [data-index="${index}"]`);
            if (item) {
                item.remove();
                socialNetworkItems = socialNetworkItems.filter(item => item.index !== index);
            }
        }

        // Driver License functions
        function handleDriverLicenseChange() {
            const hasLicense = document.getElementById('hasDriverLicense').checked;
            const categoriesDiv = document.getElementById('driverLicenseCategories');
            
            if (hasLicense) {
                categoriesDiv.style.display = 'block';
                // Update language content
                document.querySelectorAll('#driverLicenseCategories [data-kk][data-ru]').forEach(element => {
                    element.textContent = element.getAttribute('data-' + currentLanguage);
                });
            } else {
                categoriesDiv.style.display = 'none';
                selectedDriverLicenses = [];
                updateSelectedCategoriesDisplay();
            }
        }

        function showDriverLicenseModal() {
            if (vehicleCategories.length === 0) {
                alert(currentLanguage === 'kk' ? 'Категориялар жүктелуде...' : 'Загрузка категорий...');
                return;
            }
            
            const modalHTML = `
                <div class="modal show" id="driverLicenseModal" style="display: flex;">
                    <div class="modal-content" style="max-width: 500px; max-height: 70vh;">
                        <h3 style="margin-bottom: 1rem;" data-kk="Жүргізу категорияларын таңдаңыз" data-ru="Выберите категории вождения">Жүргізу категорияларын таңдаңыз</h3>
                        <div id="categoriesList" style="max-height: 400px; overflow-y: auto; border: 1px solid #e1e5e9; border-radius: 8px;">
                            ${renderDriverLicenseOptions(vehicleCategories)}
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                            <button class="btn-outline" onclick="closeDriverLicenseModal()" style="flex: 1; min-height: 44px; font-size: 1rem;" data-kk="Жабу" data-ru="Закрыть">Жабу</button>
                            <button class="btn" onclick="confirmDriverLicenseSelection()" style="flex: 1; min-height: 44px; font-size: 1rem;" data-kk="Таңдау" data-ru="Выбрать">Таңдау</button>
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;" data-kk="Бірнеше категория таңдай аласыз" data-ru="Можно выбрать несколько категорий">
                            ${currentLanguage === 'kk' ? 'Бірнеше категория таңдай аласыз' : 'Можно выбрать несколько категорий'}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            addDriverLicenseOptionClickEffects();
            restoreDriverLicenseSelections();
            
            document.querySelectorAll('#driverLicenseModal [data-kk][data-ru]').forEach(element => {
                element.textContent = element.getAttribute('data-' + currentLanguage);
            });
        }

        function renderDriverLicenseOptions(categoriesList) {
            return categoriesList.map(category => `
                <div class="driver-license-option" style="padding: 0.75rem; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: all 0.3s; display: flex; align-items: center;" 
                     data-category="${category.category}" data-description="${category.description.replace(/"/g, '&quot;')}" data-selected="false">
                    <div style="width: 100%;">
                        <div style="font-weight: 600; color: #333;">${category.category}</div>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 0.25rem;">${category.description}</div>
                    </div>
                </div>
            `).join('');
        }

        function addDriverLicenseOptionClickEffects() {
            document.querySelectorAll('.driver-license-option').forEach(option => {
                option.addEventListener('click', function() {
                    const isSelected = this.dataset.selected === 'true';
                    const categoryCode = this.dataset.category;
                    
                    if (isSelected) {
                        // Deselect
                        this.dataset.selected = 'false';
                        this.style.backgroundColor = '';
                        this.style.color = '';
                        selectedDriverLicenses = selectedDriverLicenses.filter(cat => cat.category !== categoryCode);
                    } else {
                        // Select
                        this.dataset.selected = 'true';
                        this.style.backgroundColor = '#e8f5e8';
                        this.style.color = '#2d5a32';
                        selectedDriverLicenses.push({
                            category: categoryCode,
                            description: this.dataset.description
                        });
                    }
                });
                
                option.addEventListener('mouseenter', function() {
                    if (this.dataset.selected !== 'true') {
                        this.style.backgroundColor = '#f8f9fa';
                    }
                });
                
                option.addEventListener('mouseleave', function() {
                    if (this.dataset.selected !== 'true') {
                        this.style.backgroundColor = '';
                    }
                });
            });
        }

        function restoreDriverLicenseSelections() {
            const selectedCategories = selectedDriverLicenses.map(cat => cat.category);
            document.querySelectorAll('.driver-license-option').forEach(option => {
                const categoryCode = option.dataset.category;
                
                if (selectedCategories.includes(categoryCode)) {
                    option.dataset.selected = 'true';
                    option.style.backgroundColor = '#e8f5e8';
                    option.style.color = '#2d5a32';
                } else {
                    option.dataset.selected = 'false';
                    option.style.backgroundColor = '';
                    option.style.color = '';
                }
            });
        }

        function confirmDriverLicenseSelection() {
            updateSelectedCategoriesDisplay();
            closeDriverLicenseModal();
        }

        function updateSelectedCategoriesDisplay() {
            const display = document.getElementById('selectedCategories');
            if (selectedDriverLicenses.length > 0) {
                const categoriesText = selectedDriverLicenses.map(cat => `${cat.category} - ${cat.description}`).join(', ');
                display.textContent = categoriesText;
            } else {
                display.textContent = currentLanguage === 'kk' ? 'Категориялар таңдалмаған' : 'Категории не выбраны';
            }
        }

        function closeDriverLicenseModal() {
            const modal = document.getElementById('driverLicenseModal');
            if (modal) {
                modal.remove();
            }
        }

        function addEducation() {
            const container = document.getElementById('educationContainer');
            const index = educationItems.length;
            
            const educationHTML = `
                <div class="education-item" data-index="${index}">
                    <button type="button" class="remove-btn" onclick="removeEducation(${index})">×</button>
                    <div class="form-row">
                        <div class="form-group">
                            <label data-kk="Білім түрі" data-ru="Тип образования">Білім түрі</label>
                            <select id="educationType_${index}">
                                <option value="" data-kk="Таңдаңыз" data-ru="Выберите">Таңдаңыз</option>
                                ${educationTypes.map(type => `<option value="${type.code}">${type.name}</option>`).join('')}
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-kk="Оқу орны" data-ru="Учебное заведение">Оқу орны</label>
                            <button type="button" class="btn-selector" id="universityBtn_${index}" onclick="selectUniversity(${index})">
                                <span data-kk="Университетті таңдаңыз" data-ru="Выберите университет">Университетті таңдаңыз</span>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7 10l5 5 5-5z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label data-kk="Басқа оқу орны" data-ru="Другое учебное заведение">Басқа оқу орны</label>
                            <input type="text" id="universityOther_${index}" placeholder="${currentLanguage === 'kk' ? 'Егер тізімде жоқ болса' : 'Если нет в списке'}" style="display: none;">
                        </div>
                        <div class="form-group">
                            <label data-kk="Мамандық" data-ru="Специальность">Мамандық</label>
                            <button type="button" class="btn-selector" id="specialtyBtn_${index}" onclick="selectSpecialty(${index})">
                                <span data-kk="Мамандықты таңдаңыз" data-ru="Выберите специальность">Мамандықты таңдаңыз</span>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7 10l5 5 5-5z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label data-kk="Басқа мамандық" data-ru="Другая специальность">Басқа мамандық</label>
                            <input type="text" id="specialtyOther_${index}" placeholder="${currentLanguage === 'kk' ? 'Егер тізімде жоқ болса' : 'Если нет в списке'}" style="display: none;">
                        </div>
                        <div class="form-group">
                            <label data-kk="Бітірген жылы" data-ru="Год окончания">Бітірген жылы</label>
                            <input type="number" id="graduationYear_${index}" placeholder="2024" min="1950" max="2030">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="customUniversity_${index}" onchange="toggleCustomUniversity(${index})">
                                <label for="customUniversity_${index}" data-kk="Басқа университет" data-ru="Другой университет">Басқа университет</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="customSpecialty_${index}" onchange="toggleCustomSpecialty(${index})">
                                <label for="customSpecialty_${index}" data-kk="Басқа мамандық" data-ru="Другая специальность">Басқа мамандық</label>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', educationHTML);
            educationItems.push({ 
                index,
                selectedUniversity: null,
                selectedSpecialty: null
            });
            
            // Update language content
            document.querySelectorAll(`[data-index="${index}"] [data-kk][data-ru]`).forEach(element => {
                element.textContent = element.getAttribute('data-' + currentLanguage);
            });
        }

        function removeEducation(index) {
            const item = document.querySelector(`[data-index="${index}"]`);
            if (item) {
                item.remove();
                educationItems = educationItems.filter(item => item.index !== index);
            }
        }

        function addWorkExperience() {
            const container = document.getElementById('workExperienceContainer');
            const index = workExperienceItems.length;
            
            const workHTML = `
                <div class="work-experience-item" data-index="${index}">
                    <button type="button" class="remove-btn" onclick="removeWorkExperience(${index})">×</button>
                    <div class="form-row">
                        <div class="form-group">
                            <label data-kk="Жұмыс орны" data-ru="Место работы">Жұмыс орны</label>
                            <input type="text" id="workPlace_${index}" placeholder="ҚазСтройСервис ЖШС">
                        </div>
                        <div class="form-group">
                            <label data-kk="Лауазым" data-ru="Должность">Лауазым</label>
                            <input type="text" id="jobTitle_${index}" placeholder="Құрылыс инженері">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label data-kk="Басталған күні (MM/yyyy)" data-ru="Дата начала (MM/yyyy)">Басталған күні (MM/yyyy)</label>
                            <input type="text" id="startDate_${index}" placeholder="01/2023" pattern="^(0[1-9]|1[0-2])/\\d{4}$" title="${currentLanguage === 'kk' ? 'MM/YYYY форматында енгізіңіз' : 'Введите в формате MM/YYYY'}">
                        </div>
                        <div class="form-group">
                            <label data-kk="Аяқталған күні (MM/yyyy)" data-ru="Дата окончания (MM/yyyy)">Аяқталған күні (MM/yyyy)</label>
                            <input type="text" id="endDate_${index}" placeholder="12/2023" pattern="^(0[1-9]|1[0-2])/\\d{4}$" title="${currentLanguage === 'kk' ? 'MM/YYYY форматында енгізіңіз' : 'Введите в формате MM/YYYY'}">
                        </div>
                    </div>
                    <div class="form-group">
                        <label data-kk="Міндеттер" data-ru="Обязанности">Міндеттер</label>
                        <textarea id="responsibilities_${index}" rows="3" placeholder="Жұмыс міндеттеріңізді сипаттаңыз..."></textarea>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="tillPresent_${index}">
                        <label for="tillPresent_${index}" data-kk="Қазіргі уақытқа дейін" data-ru="По настоящее время">Қазіргі уақытқа дейін</label>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', workHTML);
            workExperienceItems.push({ index });
        }

        function removeWorkExperience(index) {
            const item = document.querySelector(`.work-experience-item[data-index="${index}"]`);
            if (item) {
                item.remove();
                workExperienceItems = workExperienceItems.filter(item => item.index !== index);
            }
        }

        function validateForm() {
            const errors = [];
            
            if (!document.getElementById('firstName').value.trim()) errors.push('firstName');
            if (!document.getElementById('surName').value.trim()) errors.push('surName');
            if (!document.getElementById('email').value.trim()) errors.push('email');
            if (!selectedData.city) errors.push('city');
            if (selectedData.professions.length === 0) errors.push('professions');
            
            return errors;
        }

        function showErrors(errors) {
            errors.forEach(field => {
                const errorElement = document.getElementById(field + 'Error');
                const inputElement = document.getElementById(field) || document.getElementById(field + 'Btn');
                
                if (errorElement) {
                    errorElement.style.display = 'block';
                    errorElement.textContent = currentLanguage === 'kk' ? 'Бұл өрісті толтыру қажет' : 'Это поле обязательно';
                }
                
                if (inputElement) {
                    inputElement.classList.add('error');
                }
            });
        }

        function collectFormData() {
            // Collect education data
            const education = educationItems.map(item => {
                const index = item.index;
                const educationTypeSelect = document.getElementById(`educationType_${index}`);
                const educationTypeCode = educationTypeSelect?.value || '';
                const educationTypeName = educationTypeSelect?.selectedOptions[0]?.text || '';
                
                const customUniversity = document.getElementById(`customUniversity_${index}`)?.checked || false;
                const customSpecialty = document.getElementById(`customSpecialty_${index}`)?.checked || false;
                
                return {
                    educationType: educationTypeCode ? {
                        code: educationTypeCode,
                        name: educationTypeName
                    } : null,
                    
                    educationalInstitutionDictionary: !customUniversity && item.selectedUniversity ? {
                        id: item.selectedUniversity.id,
                        name: item.selectedUniversity.name
                    } : null,
                    
                    educationalInstitutionOther: customUniversity ? 
                        document.getElementById(`universityOther_${index}`)?.value || '' : null,
                    
                    specialityDictionary: !customSpecialty && item.selectedSpecialty ? {
                        id: item.selectedSpecialty.id,
                        name: item.selectedSpecialty.name
                    } : null,
                    
                    specialityOther: customSpecialty ? 
                        document.getElementById(`specialtyOther_${index}`)?.value || '' : null,
                    
                    graduationYear: document.getElementById(`graduationYear_${index}`)?.value || ''
                };
            });

            // Collect work experience data
            const workExperience = workExperienceItems.map(item => {
                const index = item.index;
                return {
                    workPlace: document.getElementById(`workPlace_${index}`)?.value || '',
                    jobTitle: document.getElementById(`jobTitle_${index}`)?.value || '',
                    startDate: document.getElementById(`startDate_${index}`)?.value || '',
                    endDate: document.getElementById(`endDate_${index}`)?.value || '',
                    tillPresent: document.getElementById(`tillPresent_${index}`)?.checked || false,
                    responsibilities: document.getElementById(`responsibilities_${index}`)?.value || ''
                };
            });

            // Collect additional courses data
            const additionalCourses = courseItems.map(item => {
                const index = item.index;
                const courseName = document.getElementById(`courseName_${index}`)?.value || '';
                
                return {
                    name: courseName,
                    file: item.file || null
                };
            }).filter(course => course.name.trim() !== ''); // Only include courses with names

            // Collect social networks data
            const socialNetworks = socialNetworkItems.map(item => {
                const index = item.index;
                const socialNetworkType = document.getElementById(`socialNetworkType_${index}`)?.value || '';
                const name = document.getElementById(`socialNetworkName_${index}`)?.value || '';
                const url = document.getElementById(`socialNetworkUrl_${index}`)?.value || '';
                
                return {
                    socialNetworkType: socialNetworkType,
                    name: name,
                    url: url
                };
            }).filter(social => social.socialNetworkType && (social.name.trim() !== '' || social.url.trim() !== '')); // Only include social networks with type and either name or URL

            return {
                firstName: document.getElementById('firstName').value.trim(),
                surName: document.getElementById('surName').value.trim(),
                middleName: document.getElementById('middleName').value.trim(),
                phoneNumber: document.getElementById('phoneNumber').value.trim(),
                email: document.getElementById('email').value.trim(),
                city: selectedData.city,
                expectedSalaryStart: parseFloat(document.getElementById('expectedSalaryStart').value) || 0,
                expectedSalaryEnd: parseFloat(document.getElementById('expectedSalaryEnd').value) || 0,
                workSchedule: selectedData.workSchedule,
                relocationReadiness: document.getElementById('relocationReadiness').checked,
                workPermit: document.getElementById('workPermit').checked,
                professions: selectedData.professions,
                skills: selectedData.skills,
                education: education,
                workExperience: workExperience,
                additionalCourses: additionalCourses,
                socialNetworks: socialNetworks,
                userImage: userImageFile,
                additionalInfo: document.getElementById('additionalInfo').value.trim(),
                hasDriverLicense: document.getElementById('hasDriverLicense').checked,
                driverLicenses: selectedDriverLicenses,
                bargain: document.getElementById('bargain').checked,
                advance: document.getElementById('advance').checked,
                nationality: { code: "KAZAKHSTAN", name: "Қазақстан" },
                tripReadiness: document.getElementById('tripReadiness').value || "READY",
                busynesses: selectedData.busyness.length > 0 ? selectedData.busyness : ["FULL"]
            };
        }

        async function submitCV() {
            const errors = validateForm();
            if (errors.length > 0) {
                showErrors(errors);
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner"></div>';

            try {
                const cvData = collectFormData();
                
                if(true) {
                    console.log(JSON.stringify(cvData));
                    return;
                }

                // Create CV
                const cvId = await apiService.createCV(cvData);
                console.log('CV created with ID:', cvId);
                
                // Publish CV
                await apiService.publishCV(cvId);
                console.log('CV published successfully');

                showSuccessModal();
                
            } catch (error) {
                console.error('Error creating CV:', error);
                alert(currentLanguage === 'kk' ? 'Қате орын алды. Қайталап көріңіз.' : 'Произошла ошибка. Попробуйте снова.');
            } finally {
                // Reset submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span data-kk="Резюме жасау" data-ru="Создать резюме">Резюме жасау</span>';
            }
        }

        function showSuccessModal() {
            document.getElementById('successModal').classList.add('show');
        }

        function createAnother() {
            document.getElementById('successModal').classList.remove('show');
            window.location.reload();
        }

        function goToMain() {
            window.location.href = 'cv.html';
        }

        function goBack() {
            window.location.href = 'cv.html';
        }

        function logout() {
            localStorage.removeItem('stroyka_cv_auth');
            window.location.href = 'cv.html';
        }
    </script>
    <script src="api.js"></script>
</body>
</html>
